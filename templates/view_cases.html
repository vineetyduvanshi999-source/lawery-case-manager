{% extends "base.html" %}
{% set active="view" %}
{% set heading="All Cases" %}
{% set subheading="Search, edit, delete, upload documents and export PDFs." %}

{% block content %}

<div class="panel">

  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap;">
    <div>
      <h2 style="font-size:18px; font-weight:900; color:#0b3a78;">ğŸ“‚ All Cases</h2>
      <p style="font-size:13px; color:#64748b; margin-top:4px;">
        Manage all your cases in one place.
      </p>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn btn-primary" href="/add">â• Add Case</a>
      <a class="btn btn-light" href="/export_pdf">ğŸ§¾ Export PDF</a>
    </div>
  </div>

  <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <input id="search" class="input" placeholder="Search by client name..." style="max-width:340px;">
    <button class="btn btn-primary" onclick="searchCase()">ğŸ” Search</button>
    <button class="btn btn-light" onclick="loadCases()">â†» Show All</button>
  </div>

  <div class="table-wrap" style="margin-top:16px;">
    <table class="table">
      <thead>
        <tr>
          <th>Client</th>
          <th>Case Title</th>
          <th>Court</th>
          <th>Hearing</th>
          <th>Status</th>
          <th style="min-width:360px;">Actions</th>
        </tr>
      </thead>
      <tbody id="caseTable"></tbody>
    </table>
  </div>

</div>

<script>
function statusBadge(status){
  if(!status) return `<span class="status pending">Pending</span>`;

  let s = status.toLowerCase();
  if(s === "active") return `<span class="status active">Active</span>`;
  if(s === "closed") return `<span class="status closed">Closed</span>`;
  return `<span class="status pending">Pending</span>`;
}

function renderCases(cases){
  let table = document.getElementById("caseTable");
  table.innerHTML = "";

  if(cases.length === 0){
    table.innerHTML = `<tr><td colspan="6" class="empty">No cases found.</td></tr>`;
    return;
  }

  cases.forEach(c => {

    let docHtml = "";
    if(c.document && c.document.trim() !== ""){
      docHtml = `
        <a class="btn btn-light" href="/download/${c.document}">â¬‡ Download</a>
      `;
    }

    let row = `
      <tr>
        <td>${c.client_name || ""}</td>
        <td>${c.case_title || ""}</td>
        <td>${c.court || ""}</td>
        <td>${c.hearing_date || ""}</td>
        <td>${statusBadge(c.status)}</td>

        <td>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">

            <a class="btn btn-primary" href="/edit/${c.id}">âœ Edit</a>

            <a class="btn btn-light" href="/export_case_pdf/${c.id}">
              ğŸ“„ Case PDF
            </a>

            <button class="btn btn-danger" onclick="deleteCase(${c.id})">ğŸ—‘ Delete</button>

            <input class="input" type="file" id="file${c.id}" style="max-width:180px;">
            <button class="btn btn-light" onclick="uploadDoc(${c.id})">ğŸ“ Upload</button>

            ${docHtml}
          </div>
        </td>
      </tr>
    `;

    table.innerHTML += row;
  });
}

async function loadCases(){
  let res = await fetch("/get_cases");
  let cases = await res.json();
  renderCases(cases);
}

async function searchCase(){
  let name = document.getElementById("search").value.trim();

  if(name === ""){
    loadCases();
    return;
  }

  let res = await fetch("/search/" + name);
  let cases = await res.json();
  renderCases(cases);
}

async function deleteCase(id){
  if(!confirm("Are you sure you want to delete this case?")) return;

  await fetch("/delete/" + id, { method: "DELETE" });

  alert("Case deleted!");
  loadCases();
}

async function uploadDoc(id){
  let fileInput = document.getElementById("file" + id);

  if(fileInput.files.length === 0){
    alert("Select a file first!");
    return;
  }

  let formData = new FormData();
  formData.append("file", fileInput.files[0]);

  let res = await fetch("/upload/" + id, {
    method: "POST",
    body: formData
  });

  let data = await res.json();

  if(data.error){
    alert(data.error);
    return;
  }

  alert("Document uploaded successfully!");
  loadCases();
}

loadCases();
</script>

{% endblock %}
